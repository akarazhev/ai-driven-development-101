services:
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    ports:
      - "8080:8080"
    env_file:
      # Load secrets from .env file (not committed to git)
      - .env
    environment:
      SPRING_PROFILES_ACTIVE: docker
      APP_DATABASE_URL: jdbc:sqlite:///data/app.db
      APP_ATTACHMENT_DIR: /storage/attachments
      # Confluence configuration - loaded from .env file
      # These are mapped to app.* properties in application-docker.yml
      CONFLUENCE_URL: ${CONFLUENCE_URL:-https://your-domain.atlassian.net}
      CONFLUENCE_DEFAULT_SPACE: ${CONFLUENCE_DEFAULT_SPACE:-DEV}
      CONFLUENCE_API_TOKEN: ${CONFLUENCE_API_TOKEN:-}
      CONFLUENCE_USERNAME: ${CONFLUENCE_USERNAME:-}
      CONFLUENCE_PROVIDER: ${CONFLUENCE_PROVIDER:-confluence-stub}
      SCHEDULER_INTERVAL_SECONDS: ${SCHEDULER_INTERVAL_SECONDS:-5}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:4200,http://localhost:8080,http://localhost:5173}
    volumes:
      - data:/data
      - attachments:/storage/attachments
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
      args:
        NG_APP_API_BASE: ${NG_APP_API_BASE:-http://localhost:8080}
    ports:
      - "4200:8080"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

volumes:
  data:
    driver: local
  attachments:
    driver: local
