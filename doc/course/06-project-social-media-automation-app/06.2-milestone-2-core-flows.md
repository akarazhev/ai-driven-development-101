# M2: Core Posting Flows

Implement the core functionality: creating posts, uploading media, scheduling, and publishing. This milestone builds the
essential features of your application.

## Learning objectives

- Implement media upload functionality
- Create post management endpoints
- Build scheduling system
- Implement publish flow
- Create basic UI for core features

## Prerequisites

- M1 completed (project scaffold working)
- Database schema in place
- Stub provider implemented

## Acceptance criteria

- [ ] Can upload media files
- [ ] Can create posts with text and media
- [ ] Can schedule posts for future
- [ ] Can publish posts immediately
- [ ] Can view post status
- [ ] Basic UI for compose and schedules
- [ ] Scheduler processes queued posts

## Step-by-step guide

### Step 1: Implement media upload

**Backend endpoint**:

```text
Role: Backend developer
Task: Implement media upload endpoint
Constraints:
- Endpoint: POST /api/media
- Accept: multipart/form-data with file and optional alt_text
- Validate: file type, size limits
- Store: file to storage, metadata to database
- Return: MediaAsset object with id
- Include error handling
Inputs: [Storage setup, database models]
Output format: Media upload endpoint + tests
Evaluation: Can upload files, metadata saved, validation works
```

**Frontend component**:

```text
Role: Frontend developer
Task: Create media upload component
Constraints:
- Allow file selection
- Show upload progress
- Display uploaded files
- Allow alt text input
- Handle errors gracefully
- Use [your framework] patterns
Inputs: [API client, UI design]
Output format: Upload component
Evaluation: Can upload files, see progress, handle errors
```

### Step 2: Implement post creation

**Backend endpoint**:

```text
Role: Backend developer
Task: Implement post creation endpoint
Constraints:
- Endpoint: POST /api/posts
- Accept: { text: string, media_ids: number[] }
- Validate: text not empty, media_ids exist
- Create: Post and PostMedia records
- Return: Post object with media
- Include error handling
Inputs: [Database models, validation patterns]
Output format: Post creation endpoint + tests
Evaluation: Can create posts, link media, validation works
```

**Get post endpoint**:

```text
Role: Backend developer
Task: Implement get post endpoint
Constraints:
- Endpoint: GET /api/posts/{id}
- Return: Post with associated media
- Handle: 404 if not found
- Include error handling
Inputs: [Post model, relationships]
Output format: Get post endpoint + tests
Evaluation: Returns post with media, handles 404
```

### Step 3: Implement scheduling

**Schedule endpoint**:

```text
Role: Backend developer
Task: Implement schedule endpoint
Constraints:
- Endpoint: POST /api/schedules
- Accept: { post_id: number, scheduled_at?: datetime }
- Default: scheduled_at = now (immediate)
- Create: Schedule record with status "queued"
- Validate: post exists, scheduled_at in future (if provided)
- Return: Schedule object
Inputs: [Schedule model, Post model]
Output format: Schedule endpoint + tests
Evaluation: Can schedule posts, validation works
```

**List schedules endpoint**:

```text
Role: Backend developer
Task: Implement list schedules endpoint
Constraints:
- Endpoint: GET /api/schedules
- Return: List of schedules with post info
- Filter: optional status filter
- Sort: by scheduled_at
- Include error handling
Inputs: [Schedule model, relationships]
Output format: List schedules endpoint + tests
Evaluation: Returns schedules, filtering works
```

### Step 4: Implement scheduler/worker

**Background scheduler**:

```text
Role: Backend developer
Task: Implement background scheduler for queued posts
Constraints:
- Check for queued schedules every [interval] seconds
- Process schedules where scheduled_at <= now
- Call publish service
- Update schedule status (queued → posted/failed)
- Handle errors and retries
- Limit concurrent processing
Inputs: [Schedule model, publish service]
Output format: Scheduler implementation
Evaluation: Processes queued posts, updates status, handles errors
```

**Publish service**:

```text
Role: Backend developer
Task: Implement publish service
Constraints:
- Take: post_id
- Get: post with media
- Call: provider.publish()
- Log: PublishLog entry
- Update: schedule status
- Handle: errors and retries
Inputs: [Post model, provider interface]
Output format: Publish service + tests
Evaluation: Publishes posts, logs results, handles errors
```

### Step 5: Implement publish endpoint

**Publish now endpoint**:

```text
Role: Backend developer
Task: Implement publish now endpoint
Constraints:
- Endpoint: POST /api/providers/default/publish
- Accept: { post_id: number }
- Call: publish service
- Return: PublishLog with status
- Include error handling
Inputs: [Publish service, provider]
Output format: Publish endpoint + tests
Evaluation: Can publish immediately, returns status
```

### Step 6: Build compose UI

**Compose page**:

```text
Role: Frontend developer
Task: Create compose page for creating posts
Constraints:
- Text input for post content
- Media upload section
- Preview of post
- Create post button
- Show success/error messages
- Use [your framework] patterns
Inputs: [API client, UI components]
Output format: Compose page component
Evaluation: Can create posts, upload media, see preview
```

### Step 7: Build schedules UI

**Schedules page**:

```text
Role: Frontend developer
Task: Create schedules page
Constraints:
- List all schedules
- Show: post text, scheduled time, status
- Filter by status
- Refresh button
- Use [your framework] patterns
Inputs: [API client, UI components]
Output format: Schedules page component
Evaluation: Can view schedules, filter, refresh
```

## Testing

### Test media upload

```text
Role: Test engineer
Task: Write tests for media upload
Constraints:
- Test: successful upload
- Test: file validation (type, size)
- Test: alt text handling
- Test: error cases
- Use [your testing framework]
Inputs: [Media upload endpoint]
Output format: Test file
Evaluation: All tests pass
```

### Test post creation

```text
Role: Test engineer
Task: Write tests for post creation
Constraints:
- Test: create post with text
- Test: create post with media
- Test: validation (empty text, invalid media_ids)
- Test: get post endpoint
- Use [your testing framework]
Inputs: [Post endpoints]
Output format: Test file
Evaluation: All tests pass
```

### Test scheduling

```text
Role: Test engineer
Task: Write tests for scheduling
Constraints:
- Test: schedule post
- Test: immediate schedule (no scheduled_at)
- Test: future schedule
- Test: validation
- Test: scheduler processes queued posts
- Use [your testing framework]
Inputs: [Schedule endpoints, scheduler]
Output format: Test file
Evaluation: All tests pass
```

### Test publishing

```text
Role: Test engineer
Task: Write tests for publishing
Constraints:
- Test: publish now endpoint
- Test: publish service with stub provider
- Test: error handling
- Test: publish log creation
- Use [your testing framework]
Inputs: [Publish endpoint, service]
Output format: Test file
Evaluation: All tests pass
```

## Integration testing

**E2E flow test**:

```text
Role: Test engineer
Task: Write E2E test for complete flow
Constraints:
- Test: upload media → create post → schedule → publish
- Use stub provider
- Verify: all steps work together
- Use [your E2E testing framework]
Inputs: [All endpoints, scheduler]
Output format: E2E test
Evaluation: Complete flow works end-to-end
```

## Verification checklist

Before moving to M3, verify:

- [ ] Can upload media files
- [ ] Can create posts with text and media
- [ ] Can schedule posts (immediate and future)
- [ ] Scheduler processes queued posts
- [ ] Can publish posts immediately
- [ ] Can view schedules and status
- [ ] UI works for compose and schedules
- [ ] All tests pass
- [ ] Error handling works

## Troubleshooting

### Issue: Media upload fails

**Solutions**:

- Check file size limits
- Verify storage path exists
- Check file permissions
- Review error logs

### Issue: Scheduler not running

**Solutions**:

- Verify scheduler is started
- Check interval configuration
- Review scheduler logs
- Test manually

### Issue: Posts not publishing

**Solutions**:

- Check stub provider is working
- Verify publish service is called
- Review error logs
- Test provider directly

## Next steps

Once M2 is complete, proceed to **[M3: AI-Assisted Content Generation](./06.3-milestone-3-ai-features.md)**

## Deliverables

- Media upload working
- Post creation working
- Scheduling system working
- Publishing flow working
- Basic UI for compose and schedules
- Scheduler processing queued posts
- Tests passing

